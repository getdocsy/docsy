{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
    <h2>Analysis Result for <a href="https://github.com/{{ repo_owner }}/{{ repo_name }}">{{ repo_owner }}/{{ repo_name }}</a></h2>
    <p class="text-muted">
        <small>Created on {{ created_at }}</small>
    </p>
    <p class="text-muted mb-3">If you are offering a technical product, the products documentation plays an important part in the buying decisions of your customers. Up to 90% of B2B customers reference documentation before purchasing<sup><a href="#fn1" id="ref1">1</a></sup>.</p>
    <p class="text-muted mb-3">This analysis focuses on the experience of a visitor, that hasn't used your product yet.</p>



    <!-- Single Function Analysis Section -->
    <div class="card mb-3">
        <div class="card-header">
            <div class="d-flex justify-content-between align-items-center">
                <h4>Single Function</h4>
                {% if result.single_function and result.single_function.total_score %}
                <span
                    class="badge {% if result.single_function.total_score > 85 %}bg-success{% elif result.single_function.total_score > 65 %}bg-warning{% else %}bg-danger{% endif %} fs-5">
                    {{ result.single_function.total_score }}%
                </span>
                {% endif %}
            </div>
        </div>
        <div class="card-body">
            <p class="text-muted mb-3"><b>What we check:</b> 
                We check if each page has a structure and style that matches it’s function by checking the subheadings and the type of content on each page.
            </p>
            <p class="text-muted mb-3"><b>Why it's important:</b> 
                Since users might land on any page, for example via a search engine, every page needs to be easy to understand. If a single page serves multiple functions, like a how-to guide that also contains reference information, it's confusing for the user.
            </p>
            {% if result.single_function %}

            <canvas id="functionTypesChart" class="mb-3" style="max-height: 200px;"></canvas>

            <button class="btn btn-outline-secondary mb-3" type="button" data-bs-toggle="collapse" data-bs-target="#functionTable" aria-expanded="false" aria-controls="functionTable">
                Show Score Components
            </button>

            <div class="collapse" id="functionTable">
                <h5>Score Components</h5>
                <p class="text-muted mb-3">
                    The score for this section is the average of the scores for each file.
                </p>
                <table class="table sortable-table" id="functionScoreTable">
                    <thead>
                        <tr>
                            <th class="sortable" data-sort="component">Component ↕</th>
                            <th class="sortable" data-sort="score">Score ↕</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for component, score in result.single_function.score_components.items %}
                        <tr>
                            <td>{{ component }}</td>
                            <td>{{ score }}%</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>

                <h5>File Details</h5>
                <p class="text-muted mb-3">
                    Details for each file.
                </p>
                <input type="text" id="singleFunctionSearch" class="form-control mb-3" placeholder="Search files...">
                <table class="table sortable-table" id="singleFunctionTable">
                    <thead>
                        <tr>
                            <th class="sortable" data-sort="file">File Path ↕</th>
                            <th class="sortable" data-sort="explanation">Explanation Subheadings ↕</th>
                            <th class="sortable" data-sort="tutorial">Tutorial Subheadings ↕</th>
                            <th class="sortable" data-sort="reference">Reference Subheadings ↕</th>
                            <th class="sortable" data-sort="howto">How-to Subheadings ↕</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for file in result.single_function.analysis.files %}
                        <tr>
                            <td>{{ file.file_path }}</td>
                            <td>{{ file.explanation_subheadings|join:", " }}</td>
                            <td>{{ file.tutorial_subheadings|join:", " }}</td>
                            <td>{{ file.reference_subheadings|join:", " }}</td>
                            <td>{{ file.howto_subheadings|join:", " }}</td>
                            <td>{{ file.score }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% endif %}
        </div>
    </div>

 
    <!-- Coherent Sitemap Section -->
    <div class="card mb-3">
        <div class="card-header">
            <div class="d-flex justify-content-between align-items-center">
                <h4>Coherent Sitemap</h4>
                {% if result.coherent_sitemap and result.coherent_sitemap.total_score %}
                <span
                    class="badge {% if result.coherent_sitemap.total_score > 85 %}bg-success{% elif result.coherent_sitemap.total_score > 65 %}bg-warning{% else %}bg-danger{% endif %} fs-5">
                    {{ result.coherent_sitemap.total_score }}%
                </span>
                {% endif %}
            </div>
        </div>
        <div class="card-body">
            <p class="text-muted mb-3"><b>Why it's important:</b> 
                Besides the content of the page a user is on right now, the sitemap is the next most important item for figuring out if anything else might be of relevance to them. The titles should make it easy what type of content is behind a page.
                See <a href="https://docs.divio.com/documentation-system/introduction/">Divio's documentation system</a>
                for more information on the classification used in this analysis.
            </p>
            {% if result.coherent_sitemap %}
            <!-- Add the canvas for the chart -->
            <canvas id="structureChart" class="mb-3" style="max-height: 200px;"></canvas>
            
            <button class="btn btn-outline-secondary mb-3" type="button" data-bs-toggle="collapse" data-bs-target="#structureTable" aria-expanded="false" aria-controls="structureTable">
                Show Score Components
            </button>

            <div class="collapse" id="structureTable">
                <h5>Score Components</h5>
                <p class="text-muted mb-3">
                    The score for this section is the average of the score components.
                </p>
                <table class="table mb-3">
                    <thead>
                        <tr>
                            <th>Component</th>
                            <th>Score</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for component, score in result.coherent_sitemap.score_components.items %}
                        <tr>
                            <td>{{ component }}</td>
                            <td>{{ score }}%</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>

                <h5>File Details</h5>
                <p class="text-muted mb-3">
                    The score components are based on these files.
                </p>
                <input type="text" id="coherentSitemapSearch" class="form-control mb-3" placeholder="Search files...">
                <table class="table sortable-table" id="coherentSitemapTable">
                    <thead>
                        <tr>
                            <th class="sortable" data-sort="file">File Path ↕</th>
                            <th class="sortable" data-sort="classification">Classification ↕</th>
                            <th class="sortable" data-sort="confidence">Confidence Score ↕</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for file in result.coherent_sitemap.analysis.files %}
                        <tr>
                            <td>{{ file.path }}</td>
                            <td>{{ file.classification }}</td>
                            <td>{{ file.confidence_score }}%</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% endif %}
        </div>
    </div>

<h2> Methodology</h2>

    <p>We make the following assumptions backed by the data of the 2024 Technical Content Benchmark Report by Zoomin (which is based on nearly 100 million sessions accross 136 countries)<sup><a href="#fn1" id="ref1">1</a></sup>,</p>

    <ul>
        <li>The average visitor spends 5 minutes on the documentation.</li>
        <li>The average visitor opens 5 pages during.</li>
        <li>On average, 15% of sessions include in-site-search.</li>
        <li>Up to 60% of traffic for public documentation comes from external searches.</li>
    </ul>


    <p>We are using the Divio Documentation System to classify pages by their four our functions: tutorials, how-to guides, technical reference and explanation. Each of those functions requires a different structure and style to be effective.<sup><a href="#fn2" id="ref2">2</a></sup>.</p>

<!-- Add Footnotes Section -->
<div class="container mt-4 mb-5">
    <hr>
    <div class="footnotes">
        <h5>Footnotes</h5>
        <ol class="small text-muted">
            <li id="fn1"><a href="https://www.zoominsoftware.com/zoomin-benchmark-report-2024">Zoomin Technical Content Benchmark Report 2024</a>
                <a href="#ref1" class="footnote-backref">↩</a>
            </li>
            <li id="fn2"><a href="https://docs.divio.com/documentation-system/">Divio's documentation system</a>
                <a href="#ref2" class="footnote-backref">↩</a>
            </li>
            <li id="fn3"><a href="https://go.zoominsoftware.com/l/1018802/2023-03-30/31mm/1018802/1680165089dCzvU0DA/The_state_of_self_service_content_experiences___Research_Brief.pdf">Frost & Sullivan, "The state of
                self-service content
                experiences", 2021</a>
                <a href="#ref3" class="footnote-backref">↩</a>
            </li>
        </ol>
    </div>
</div>

<!-- Add this before the endblock -->
{% if result.coherent_sitemap %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const files = JSON.parse(document.getElementById('structure-files').textContent);
    const classifications = {
        'Tutorial': 0,
        'How-to guide': 0,
        'Reference': 0,
        'Explanation': 0
    };
    
    files.forEach(file => {
        if (classifications.hasOwnProperty(file.classification)) {
            classifications[file.classification]++;
        }
    });

    const ctx = document.getElementById('structureChart').getContext('2d');
    new Chart(ctx, {
        type: 'pie',
        data: {
            labels: Object.keys(classifications),
            datasets: [{
                data: Object.values(classifications),
                backgroundColor: [
                    'rgba(54, 162, 235, 0.6)',  // Tutorial
                    'rgba(255, 99, 132, 0.6)',  // How-to guide
                    'rgba(75, 192, 192, 0.6)',  // Reference
                    'rgba(255, 206, 86, 0.6)'   // Explanation
                ],
                borderColor: [
                    'rgba(54, 162, 235, 1)',
                    'rgba(255, 99, 132, 1)',
                    'rgba(75, 192, 192, 1)',
                    'rgba(255, 206, 86, 1)'
                ],
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                title: {
                    display: true,
                    text: 'Documentation Type Distribution'
                },
                legend: {
                    position: 'right',
                    display: true
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const total = Object.values(classifications).reduce((a, b) => a + b, 0);
                            const percentage = ((context.raw / total) * 100).toFixed(1);
                            return `${context.label}: ${percentage}%`;
                        }
                    }
                }
            }
        }
    });
});
</script>

<!-- Add this to provide the data -->
{{ result.coherent_sitemap.analysis.files|json_script:"structure-files" }}
{% endif %}

<style>
    .sortable {
        cursor: pointer;
        user-select: none;
    }
    .sortable:hover {
        background-color: #f8f9fa;
    }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize sorting and filtering for all sortable tables
    document.querySelectorAll('.sortable-table').forEach(table => {
        initializeTableFunctionality(table);
    });

    function initializeTableFunctionality(table) {
        const tableId = table.id;
        const searchInput = document.getElementById(tableId === 'singleFunctionTable' ? 'singleFunctionSearch' : 'coherentSitemapSearch');
        let sortDirection = 1;
        let lastSortedColumn = null;

        // Filtering function
        searchInput.addEventListener('input', function() {
            const searchTerm = this.value.toLowerCase();
            const rows = table.getElementsByTagName('tr');

            for (let i = 1; i < rows.length; i++) {
                const row = rows[i];
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(searchTerm) ? '' : 'none';
            }
        });

        // Sorting function
        table.querySelectorAll('.sortable').forEach(header => {
            header.addEventListener('click', function() {
                const column = this.dataset.sort;
                const rows = Array.from(table.getElementsByTagName('tr')).slice(1);
                
                if (lastSortedColumn === column) {
                    sortDirection *= -1;
                } else {
                    sortDirection = 1;
                }
                lastSortedColumn = column;

                rows.sort((a, b) => {
                    let aValue = a.children[getColumnIndex(table, column)].textContent;
                    let bValue = b.children[getColumnIndex(table, column)].textContent;
                    
                    // Handle numeric values
                    if (column === 'confidence' || column === 'score') {
                        aValue = parseFloat(aValue);
                        bValue = parseFloat(bValue);
                    }
                    
                    if (aValue < bValue) return -1 * sortDirection;
                    if (aValue > bValue) return 1 * sortDirection;
                    return 0;
                });

                const tbody = table.getElementsByTagName('tbody')[0];
                rows.forEach(row => tbody.appendChild(row));
            });
        });
    }

    function getColumnIndex(table, column) {
        const headers = table.querySelectorAll('th');
        for (let i = 0; i < headers.length; i++) {
            if (headers[i].dataset.sort === column) {
                return i;
            }
        }
        return 0;
    }
});
</script>

<!-- Add this before the endblock -->
{% if result.single_function %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Extract data from score components
    const scoreComponents = JSON.parse(document.getElementById('single-function-data').textContent);
    const typeCounts = {0: 0, 1: 0, 2: 0, 3: 0, 4: 0};
    
    Object.keys(scoreComponents).forEach(key => {
        if (key.includes('has')) {
            const count = parseInt(key.match(/has (\d+) type/)[1]);
            typeCounts[count]++;
        }
    });

    const ctx = document.getElementById('functionTypesChart').getContext('2d');
    new Chart(ctx, {
        type: 'bar',
        data: {
            labels: ['0 Types', '1 Type', '2 Types', '3 Types', '4 Types'],
            datasets: [{
                label: 'Number of Pages',
                data: Object.values(typeCounts),
                backgroundColor: 'rgba(54, 162, 235, 0.6)',
                borderColor: 'rgba(54, 162, 235, 1)',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                title: {
                    display: true,
                    text: 'Distribution of Content Types per Page'
                },
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        stepSize: 1
                    }
                }
            }
        }
    });
});
</script>

<!-- Add this to provide the data -->
{{ result.single_function.score_components|json_script:"single-function-data" }}
{% endif %}
{% endblock %}