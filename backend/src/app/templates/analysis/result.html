{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
    <h2>Analysis Result for <a href="https://github.com/{{ repo_owner }}/{{ repo_name }}">{{ repo_owner }}/{{ repo_name }}</a></h2>
    <p class="text-muted">
        <small>Created on {{ created_at }}</small>
    </p>
    <p class="text-muted mb-3">If you are offering a technical product, the products documentation plays an important part in the buying decisions of your customers. Up to 90% of B2B customers reference documentation before purchasing. 
    This analysis focuses on the experience of a visitor, that hasn't used your product yet.</p>

    <!-- Coherent Sitemap Section -->
    <div class="card mb-3">
        <div class="card-header">
            <div class="d-flex justify-content-between align-items-center">
                <h4>Coherent Sitemap</h4>
                {% if result.coherent_sitemap and result.coherent_sitemap.total_score %}
                <span
                    class="badge {% if result.coherent_sitemap.total_score > 85 %}bg-success{% elif result.coherent_sitemap.total_score > 65 %}bg-warning{% else %}bg-danger{% endif %} fs-5">
                    {{ result.coherent_sitemap.total_score }}%
                </span>
                {% endif %}
            </div>
        </div>
        <div class="card-body">
            <p class="text-muted mb-3"><b>Why it's important:</b> 
                Besides the content of the page a user is on right now, the sitemap is the next most important item for figuring out if anything else might be of relevance to them. The titles should make it easy what type of content is behind a page.
                See <a href="https://docs.divio.com/documentation-system/introduction/">Divio's documentation system</a>
                for more information on the classification used in this analysis.
            </p>
            {% if result.coherent_sitemap %}
            <!-- Add the canvas for the chart -->
            <canvas id="structureChart" class="mb-3" style="max-height: 200px;"></canvas>
            
            <button class="btn btn-outline-secondary mb-3" type="button" data-bs-toggle="collapse" data-bs-target="#structureTable" aria-expanded="false" aria-controls="structureTable">
                Show Score Components
            </button>
            
            <div class="collapse" id="structureTable">
                <p class="text-muted mb-3">
                    Besides the content of the page a user is on right now, the sitemap is the next most important item for figuring out if anything else might be of relevance to them. The titles should make it easy what type of content is behind a page.
                    <br>
                    - Average confidence score when estimating pages to functions based on their title  
                </p>
                <table class="table">
                    <thead>
                        <tr>
                            <th>File Path</th>
                            <th>Classification</th>
                            <th>Confidence Score</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for file in result.coherent_sitemap.analysis.files %}
                        <tr>
                            <td>{{ file.path }}</td>
                            <td>{{ file.classification }}</td>
                            <td>{{ file.confidence_score }}%</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% endif %}
        </div>
    </div>

 

<!-- Add this before the endblock -->
{% if result.coherent_sitemap %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const files = JSON.parse(document.getElementById('structure-files').textContent);
    const classifications = {};
    
    files.forEach(file => {
        classifications[file.classification] = (classifications[file.classification] || 0) + 1;
    });

    const ctx = document.getElementById('structureChart').getContext('2d');
    new Chart(ctx, {
        type: 'pie',
        data: {
            labels: Object.keys(classifications),
            datasets: [{
                data: Object.values(classifications),
                backgroundColor: [
                    'rgba(54, 162, 235, 0.6)',
                    'rgba(255, 99, 132, 0.6)',
                    'rgba(75, 192, 192, 0.6)',
                    'rgba(255, 206, 86, 0.6)'
                ],
                borderColor: [
                    'rgba(54, 162, 235, 1)',
                    'rgba(255, 99, 132, 1)',
                    'rgba(75, 192, 192, 1)',
                    'rgba(255, 206, 86, 1)'
                ],
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                title: {
                    display: true,
                    text: 'Documentation Type Distribution'
                },
                legend: {
                    position: 'right',
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const total = Object.values(classifications).reduce((a, b) => a + b, 0);
                            const percentage = ((context.raw / total) * 100).toFixed(1);
                            return `${context.label}: ${percentage}%`;
                        }
                    }
                }
            }
        }
    });
});
</script>

<!-- Add this to provide the data -->
{{ result.coherent_sitemap.analysis.files|json_script:"structure-files" }}
{% endif %}
{% endblock %}